{%extends '_sticky_navbar_footer.html'%}
{%block css_sticky%}
<link href="/static/css/filestyle.css" rel="stylesheet">
<link href="/static/css/jquery.contextMenu.css" rel="stylesheet">
    <script src="/static/js/socket.io-1.3.0.js"></script>
        <script src="/static/js/jquery.js"></script>
        <script src="/static/js/bit-sync.js"></script>
        <script>
            //data变量用来存储 文件的数据
            var data;
            var files;
            //将 文件内容读取到 data变量中
            function convert() {
                files = document.getElementById('inputfile').files;
                file = files[0];
                var reader = new FileReader();

                reader.onload = function(e) {
                    //var arrayBuffer = reader.result;
                    data = e.target.result;
                    //data = new Uint8Array([1,1]);
                    var bufferView8 = new Uint8Array(data);
                    data = bufferView8.buffer.slice(0);
                    commit("{{user.email}}/"+file.name);
                }

                reader.readAsArrayBuffer(file);
            }

        </script>
        <script>
            //建立 socket io 连接
            var socket = io("http://127.0.0.1:3000");
            //客户端提交文件申请，参数为文件名
            function commit(filename){
                socket.emit('commit',filename);
            }
            //客户端接收到服务器传来的文件checksum，计算patchDoc
            socket.on('doc', function(doc){
                sendPatchDoc(doc);
            });
            //客户端将patchDoc发送给服务器
            function sendPatchDoc(doc){
                var array = $.map(doc, function(value, index) {
                    return [value];
                });
                docView = new Uint8Array(array);
                //console.log("===== doc view =====")
                //console.log(docView);
                docViewBuffer = docView.buffer.slice(0);
                //console.log(new Uint8Array(docViewBuffer));
                //console.log(new Uint8Array(data));
                patchDocument = BSync.createPatchDocument(docViewBuffer, data);
                //console.log(new Uint8Array(patchDocument));
                //console.log('send over');
                socket.emit('patchDoc',patchDocument)
            }
            //客户端接受到服务器返回的结果
            socket.on('result',function(result){
                console.log(result);window.location.reload(false);

            })

        </script>
{%endblock%}
{%block header%}
    
        <!--[if !IE]><!--> 
        <div class="navbar navbar-fixed-top">
      <div class="container" style="background-color:#f7faff">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand logo_48_196" href="/"></a>
      </div>
       <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav pull-right">
        <li class="dropdown">
          <a id="drop4" role="button" data-toggle="dropdown" href="#">{{user.email}} <b class="caret"></b></a>
          <ul id="menu1" class="dropdown-menu" role="menu" aria-labelledby="drop4">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">个人信息</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="/logout">退出</a></li>
          </ul>
        </li>
        </ul>
      </div>
      </div>
      </div>
      <!--<![endif]-->

      <!--[if lte IE 9]>
      <style type="text/css">
      body{
        min-width:600px;
        max-width:1100px;
        margin:0 auto -90px;
      }
      .fileheader-fiexed-top{
        max-width:1100px;
        margin:0 auto;
      }
      </style>
        <div class="header">
        <div class="container">
        <ul class="nav nav-pills pull-right">
        <li class="dropdown">
          <a id="drop4" role="button" data-toggle="dropdown" href="#">{{user.email}} <b class="caret"></b></a>
          <ul id="menu1" class="dropdown-menu" role="menu" aria-labelledby="drop4">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="#">个人信息</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="/logout">退出</a></li>
          </ul>
        </li>
        </ul>
        <h3 class="text-muted"><a class="navbar-brand logo_48_196" href="/"><span class="logo_48_196_hidden_hover"></span></a></h3>
        </div>
      </div>
      <![endif]-->
    
<div class="fileheader-fiexed-top" >
    <div id="overallcontrol" class="container"> 
    <div class="span8">
        <div id="filelevel">

            <a class="btn btn-default btn-sm" href="?">全部文件</a>
            {% for level in final_filelevel_list %}
                <a class="btn btn-default btn-sm" href="?current_dir={{ level.href }}">{{ level.name}}</a>
            {% endfor %}
        </div>
        <div id="uploadcontrol" class="pull-right">
            <button class="btn btn-primary" data-toggle="modal" data-target="#uploadModal">
                上传
            </button>
        <!--    <button class="btn btn-primary btn-sm">新建文件夹</button>-->
        </div>
     </div>
    </div>

</div>
<!-- Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="uploadModalLabel">上传文件</h4>
      </div>
      <div class="modal-body">
        <form class="form-inline" method="POST" enctype="multipart/form-data" action="/uploadhandler">
                {% csrf_token %}
                 <div class="form-group"> <input id="inputfile" type="file" name="file" required=""/></div>

                <input type="hidden" name="current_dir" value="{{ current_dir }}"/>
                <div class="form-group"> <input type="submit" class="btn btn-primary btn-sm" value="上传"/></div>
             <div class="form-group"> <a href="javascript:convert()" class="btn btn-success btn-sm" >同步</a></div>
        </form>
      </div>
      <div class="modal-footer">
        <a type="button" class="btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal fade" id="downloadModal" tabindex="-1" role="dialog" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="downloadModalLabel">下载文件</h4>
      </div>
      <div class="modal-body">
          <form action="/download_file" method="get" id="download_window">
              <input type="hidden" id="downloadfilename" name="file_name"/>
              <input type="hidden" name="current_dir" value="{{ current_dir }}"/>
              <input type="submit" class="btn btn-primary btn-large" value="下载"/>
          </form>
      </div>
      <div class="modal-footer">
        <a type="button" class="btn btn-default" data-dismiss="modal">取消</a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{%endblock%}
{%block content%}
<div id="filelist" class="container" >

    <table class="table table-hover" id="filetable">

        <thead>
          <tr>
            <th class="listcheckbox"></th>
            <th class="listfilename" ><a href='/home/files?order_by=filename&current_dir={{ current_dir }}&sort_method={% if sort_method == 'desc' %}{{ 'asc' }}{% else %}{{ 'desc' }}{% endif %}'>文件名</a></th>
            <th class="allcontrol"><span id="operateonfiles">文件操作</span></th>
            <th class="listsize"><a href='/home/files?order_by=size&current_dir={{ current_dir }}&sort_method={% if sort_method == 'desc' %}{{ 'asc' }}{% else %}{{ 'desc' }}{% endif %}'>大小</a></th>
            <th class="listdate"><a href='/home/files?order_by=last_modified&current_dir={{ current_dir }}&sort_method={% if sort_method == 'desc' %}{{ 'asc' }}{% else %}{{ 'desc' }}{% endif %}'>修改日期</a></th>
          </tr>
        </thead>
    <tbody id='filebody'>

         {%for file in file_list%}
            <tr class='fileinfo'>
                <td class='listcheckbox'><input type="checkbox" class="checkfile" name="checkedfile" value="{{ file.name }}"></td>
                <td class="listfilename"><a {% if file.filetype == 'file' %}onclick="handle_click_file('{{file.name }}')" href="javascript:" data-toggle="modal" data-target="#downloadModal"{% else %}href='?current_dir={{ file.this_dir }}'{% endif %} >{% if file.filetype == 'file' %}<span class="glyphicon glyphicon-file" aria-hidden="true" style="position:inherit;margin-right:5px"></span>{% else %}<span class="glyphicon glyphicon-folder-close" aria-hidden="true" style="position:inherit;margin-right:5px"></span>{% endif %}{{file.name}}</a></td>
                <td class="filecontrol"><form action="/delete_file" method="post" style="float:left"> {% csrf_token %}<input type="hidden" name="file_name" value="{{file.name}}"/><input type="hidden" name="current_dir" value="{{current_dir}}"/></form><a class="delete-file" href="javascript:;" style="float:left">删除</a><a class="rename-file"  href="javascript:;"style="float:left">重命名</a></td>
                <td class="listsize">{{file.bytes}}bytes</td>
                <td class="listdate">{{file.last_modified}}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

        <script type="application/javascript">
            function verifyData(buffer1, buffer2)
            {
              var buffer1View8 = new Uint8Array(buffer1);
              var buffer2View8 = new Uint8Array(buffer2);

              if(buffer1.byteLength != buffer2.byteLength) return false;

              var pass = true;
              for(var i=0; i<buffer1View8.length; i++)
                if(buffer1View8[i] != buffer2View8[i])
                {
                  pass=false;
                  break;
                }
              return pass;
            }

        </script>
{%endblock%}
{%block js%}
    <script type="text/javascript" src="/static/js/base64.js"></script>
    <script type="text/javascript" src="/static/js/jquery.contextMenu.js"></script>
    <script>
    $(function(){
    $('#filebody').contextMenu({
            selector: 'tr',
            callback: function(key, options) {
                if (key=='delete'){$(this).children(".filecontrol").children('form').submit()}
                else if (key=='rename'){
                     $current_file_name = $(this).children('.listfilename').text()

             $(this).children('.listfilename').html("<form method='get' action='/rename_file'><input type='hidden' name='current_dir' value='{{ current_dir }}'> <input type='text' value='"+ $current_file_name +"' name='new_name'/><input type='hidden' value='"+$current_file_name+"' name='old_name'/><input type='submit' class='btn btn-sm btn-danger'><a class='btn btn-sm btn-default' href='/home/files' >取消</a></form>")
                }
                else if(key == 'download'){
                    file_name = $(this).children('.listfilename').text()
                   $('#downloadfilename').val(file_name);
                    $("#download_window").submit()

                }

            },
            items: {

                "delete": {name: "删除"},
                "rename": {name: "重命名"}
            }
        });
    });
    </script>
    <script type="text/javascript">
        $(document).ready(function(){
            $(".checkfile").bind('click',function(){

                    var no_checked = true
                    $(":checkbox:checked").each(function(){

                           if($(this).prop("checked")){
                               no_checked = false
                           }
                    });
                if(!no_checked){
                        $("#operateonfiles").html("<a href='javascript:' onclick='batch_download()' >批量下载</a>");
                    }
                else{
                    $("#operateonfiles").html("文件操作");
                }
                });
            $('.hash-changer').bind('click', function() {
                var hash = $(this).attr('href');
                hashchanged(hash);
            });
            $("#checkboxcontrol").click(function(){
                if($(this).prop('checked')==true){
                    $(".checkboxset").each(function(){
                      $(this).prop("checked", true);
                    })
                }
                else{
                   $(".checkboxset").each(function(){
                      $(this).prop("checked", false);
                    })
                }
            })
          $(".rename-file").bind('click',function(){
             $current_file_name = $(this).parent().parent().children('.listfilename').text()
             $(this).parent().parent().children('.listfilename').html("<form method='get' action='/rename_file'> <input type='hidden' name='current_dir' value='{{ current_dir }}'><input type='text' value='"+ $current_file_name +"' name='new_name'/><input type='hidden' value='"+$current_file_name+"' name='old_name'/><input type='submit' class='btn btn-sm btn-danger' value='提交'><a class='btn btn-sm btn-default' href='/home/files' >取消</a></form>")
                
            })
          $(".delete-file").bind('click',function(){

              $(this).parent().children('form').submit()

          })
        });
        function handle_click_file(file_name){
                $('#downloadModalLabel').html(file_name);
                $('#downloadfilename').val(file_name);
        }
        function batch_download(){
            var all_files = '';
             $(":checkbox:checked").each(function(){
                    console.log($(this).val());
                         all_files+= $(this).val()+"#";
             }
             );
            console.log(all_files);
             var url = '/batchDownload'; // 取Form中要提交的链接
        var param = {}; // 组装发送参数
        param['files']  = all_files;
        param['current_dir'] = '{{ current_dir }}';
      $.get(url, param, function(dom) {
          location.href = '/media/buffer/batched/'+dom;
      });
        }



    </script>

{%endblock%}

